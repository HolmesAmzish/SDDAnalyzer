<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据展示</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- 引入 Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding-top: 20px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-size: 1.2rem;
        }
        .card-body {
            background-color: #fff;
            padding: 20px;
        }
        .btn-refresh {
            margin: 20px auto;
            display: block;
            font-size: 16px;
            padding: 12px 30px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 25px;
            transition: background-color 0.3s;
        }
        .btn-refresh:hover {
            background-color: #218838;
        }
        .data-item {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .data-item img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-top: 10px;
            border-radius: 8px;
        }
        .data-item strong {
            color: #333;
        }
        .container-fluid {
            max-width: 1200px;
        }
        #chart-container {
            margin-top: 30px;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h1 class="text-center mb-4">数据展示面板</h1>

    <button class="btn-refresh" onclick="fetchData()">刷新数据</button>

    <div class="row">
        <!-- 数据列表部分 -->
        <div class="col-lg-8">
            <div id="data-container" class="card">
                <div class="card-header">
                    数据列表
                </div>
                <div class="card-body">
                    <!-- 数据项会被动态插入在这里 -->
                </div>
            </div>
        </div>

        <!-- 图表展示部分 -->
        <div class="col-lg-4">
            <div id="chart-container" class="card">
                <div class="card-header">
                    数据占比图
                </div>
                <div class="card-body">
                    <canvas id="labelChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let chartInstance = null; // 用于存储图表实例，防止重复创建

    function parseLabel(labelStr) {
        try {
            const defectDict = ["夹杂物", "补丁", "划痕", "其他"];
            const boolArray = labelStr.replace(/\[|\]/g, '').trim().split(/\s+/).map(v => v.toLowerCase() === 'true');
            return boolArray.map((val, index) => val ? defectDict[index] : null).filter(v => v !== null);
        } catch (e) {
            return ['解析错误'];
        }
    }

    async function fetchData() {
        const container = document.getElementById('data-container').querySelector('.card-body');
        container.innerHTML = '<div class="text-center">加载中...</div>';

        try {
            const response = await fetch('/api/data/getAll');
            if (!response.ok) throw new Error('数据获取失败');
            const data = await response.json();
            container.innerHTML = '';

            // 统计 Label 数据占比
            let labelCounts = {"夹杂物": 0, "补丁": 0, "划痕": 0, "其他": 0};

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'data-item';

                let imgTag = item.resFig ? `<img src="data:image/png;base64,${item.resFig}" alt="图像">` : '';

                let detectedLabels = parseLabel(item.label);
                detectedLabels.forEach(label => {
                    if (labelCounts.hasOwnProperty(label)) {
                        labelCounts[label]++;
                    }
                });

                div.innerHTML = `
                    <strong>ID:</strong> ${item.figId} <br>
                    <strong>Name:</strong> ${item.name} <br>
                    <strong>Date:</strong> ${item.date} <br>
                    <strong>Time:</strong> ${item.time} <br>
                    <strong>Label:</strong> ${detectedLabels.join(', ')} <br>
                    <strong>Num:</strong> ${item.num} <br>
                    <strong>Dice:</strong> ${item.dice} <br>
                    ${imgTag}
                `;
                container.appendChild(div);
            });

            updateChart(labelCounts);
        } catch (error) {
            container.innerHTML = `<p class="text-danger">错误: ${error.message}</p>`;
        }
    }

    function updateChart(labelCounts) {
        const ctx = document.getElementById('labelChart').getContext('2d');

        // 清除旧图表
        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(labelCounts),
                datasets: [{
                    data: Object.values(labelCounts),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    fetchData();
</script>

</body>
</html>
